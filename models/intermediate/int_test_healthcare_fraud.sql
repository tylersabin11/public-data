with beneficiary_data as (
  select
    beneficiary_id,
    date_of_birth,
    case when date_of_death is null then 'Alive' else date_of_death end as date_of_death,
    gender,
    race,
    state,
    county,
    chronic_cond_alzheimer,
    chronic_cond_heart_failure,
    chronic_cond_kidney_disease,
    chronic_cond_cancer,
    chronic_cond_obstr_pulmonary,
    chronic_cond_depression,
    chronic_cond_diabetes,
    chronic_cond_ischemic_heart,
    chronic_cond_osteoporasis,
    chronic_cond_rheumatoid_arthritis,
    chronic_cond_stroke,
    ip_annual_reimbursement_amount,
    ip_annual_deductible_amount,
    op_annual_reimbursement_amount,
    op_annual_deductible_amount
  from {{ ref('stg_test_beneficiary_info') }}
),
inpatient_data as (
  select
    beneficiary_id,
    claim_id as ip_claim_id,
    claim_start_date as ip_claim_start_date,
    claim_end_date as ip_claim_end_date,
    provider,
    claim_amount_reimbursed as ip_claim_amount_reimbursed,
    attending_physician as ip_attending_physician,
    operating_physician as ip_operating_physician,
    other_physician as ip_other_physician,
    admission_date as ip_admission_date,
    claim_admit_diagnosis_code as ip_claim_admit_diagnosis_code,
    deductible_amount_paid as ip_deductible_amount_paid,
    discharge_date as ip_discharge_date,
    diagnosis_group_code as ip_diagnosis_group_code,
    claim_diagnosis_code_1 as ip_claim_diagnosis_code_1,
    claim_diagnosis_code_2 as ip_claim_diagnosis_code_2,
    claim_diagnosis_code_3 as ip_claim_diagnosis_code_3,
    claim_diagnosis_code_4 as ip_claim_diagnosis_code_4,
    claim_diagnosis_code_5 as ip_claim_diagnosis_code_5,
    claim_diagnosis_code_6 as ip_claim_diagnosis_code_6,
    claim_diagnosis_code_7 as ip_claim_diagnosis_code_7,
    claim_diagnosis_code_8 as ip_claim_diagnosis_code_8,
    claim_diagnosis_code_9 as ip_claim_diagnosis_code_9,
    claim_diagnosis_code_10 as ip_claim_diagnosis_code_10,
    claim_procedure_code_1 as ip_claim_procedure_code_1,
    claim_procedure_code_2 as ip_claim_procedure_code_2,
    claim_procedure_code_3 as ip_claim_procedure_code_3,
    claim_procedure_code_4 as ip_claim_procedure_code_4,
    claim_procedure_code_5 as ip_claim_procedure_code_5,
    claim_procedure_code_6 as ip_claim_procedure_code_6,
    row_number() over(partition by beneficiary_id order by claim_start_date desc) as ip_first_claim
  from {{ ref('stg_test_inpatient_data') }}
),
outpatient_data as (
  select 
    beneficiary_id,
    claim_id as op_claim_id,
    claim_start_date as op_claim_start_date,
    claim_end_date as op_claim_end_date,
    provider,
    claim_amount_reimbursed as op_claim_amount_reimbursed,
    attending_physician as op_attending_physician,
    operating_physician as op_operating_physician,
    other_physician as op_other_physician,
    claim_diagnosis_code_1 as op_claim_diagnosis_code_1,
    claim_diagnosis_code_2 as op_claim_diagnosis_code_2,
    claim_diagnosis_code_3 as op_claim_diagnosis_code_3,
    claim_diagnosis_code_4 as op_claim_diagnosis_code_4,
    claim_diagnosis_code_5 as op_claim_diagnosis_code_5,
    claim_diagnosis_code_6 as op_claim_diagnosis_code_6,
    claim_diagnosis_code_7 as op_claim_diagnosis_code_7,
    claim_diagnosis_code_8 as op_claim_diagnosis_code_8,
    claim_diagnosis_code_9 as op_claim_diagnosis_code_9,
    claim_diagnosis_code_10 as op_claim_diagnosis_code_10,
    claim_procedure_code_1 as op_claim_procedure_code_1,
    claim_procedure_code_2 as op_claim_procedure_code_2,
    claim_procedure_code_3 as op_claim_procedure_code_3,
    claim_procedure_code_4 as op_claim_procedure_code_4,
    claim_procedure_code_5 as op_claim_procedure_code_5,
    claim_procedure_code_6 as op_claim_procedure_code_6,
    deductible_amount_paid as op_deductible_amount_paid,
    claim_admit_diagnosis_code as op_claim_admit_diagnosis_code,
    row_number() over(partition by beneficiary_id order by claim_start_date desc) as op_first_claim
  from {{ ref('stg_test_outpatient_data') }}
),
provider_info as (
  select
    provider
  from {{ ref('stg_test_provider_info') }}
)


select 
  bd.beneficiary_id,
  bd.date_of_birth,
  bd.gender,
  bd.race,
  bd.state,
  bd.county,
  bd.chronic_cond_alzheimer,
  bd.chronic_cond_heart_failure,
  bd.chronic_cond_kidney_disease,
  bd.chronic_cond_cancer,
  bd.chronic_cond_obstr_pulmonary,
  bd.chronic_cond_depression,
  bd.chronic_cond_diabetes,
  bd.chronic_cond_ischemic_heart,
  bd.chronic_cond_osteoporasis,
  bd.chronic_cond_rheumatoid_arthritis,
  bd.chronic_cond_stroke,
  pi.provider,
  id.ip_claim_id,
  id.ip_claim_start_date,
  id.ip_claim_end_date,
  id.ip_claim_amount_reimbursed,
  id.ip_attending_physician,
  id.ip_operating_physician,
  id.ip_other_physician,
  id.ip_admission_date,
  id.ip_claim_admit_diagnosis_code,
  id.ip_deductible_amount_paid,
  id.ip_discharge_date,
  id.ip_diagnosis_group_code,
  id.ip_claim_diagnosis_code_1,
  id.ip_claim_diagnosis_code_2,
  id.ip_claim_diagnosis_code_3,
  id.ip_claim_diagnosis_code_4,
  id.ip_claim_diagnosis_code_5,
  id.ip_claim_diagnosis_code_6,
  id.ip_claim_diagnosis_code_7,
  id.ip_claim_diagnosis_code_8,
  id.ip_claim_diagnosis_code_9,
  id.ip_claim_diagnosis_code_10,
  id.ip_claim_procedure_code_1,
  id.ip_claim_procedure_code_2,
  id.ip_claim_procedure_code_3,
  id.ip_claim_procedure_code_4,
  id.ip_claim_procedure_code_5,
  id.ip_claim_procedure_code_6,
  od.op_claim_id,
  od.op_claim_start_date,
  od.op_claim_end_date,
  od.op_claim_amount_reimbursed,
  od.op_attending_physician,
  od.op_operating_physician,
  od.op_other_physician,
  od.op_claim_diagnosis_code_1,
  od.op_claim_diagnosis_code_2,
  od.op_claim_diagnosis_code_3,
  od.op_claim_diagnosis_code_4,
  od.op_claim_diagnosis_code_5,
  od.op_claim_diagnosis_code_6,
  od.op_claim_diagnosis_code_7,
  od.op_claim_diagnosis_code_8,
  od.op_claim_diagnosis_code_9,
  od.op_claim_diagnosis_code_10,
  od.op_claim_procedure_code_1,
  od.op_claim_procedure_code_2,
  od.op_claim_procedure_code_3,
  od.op_claim_procedure_code_4,
  od.op_claim_procedure_code_5,
  od.op_claim_procedure_code_6,
  od.op_deductible_amount_paid,
  od.op_claim_admit_diagnosis_code,
  bd.ip_annual_reimbursement_amount,
  bd.ip_annual_deductible_amount,
  bd.op_annual_reimbursement_amount,
  bd.op_annual_deductible_amount,
from
  beneficiary_data as bd
left join
  inpatient_data as id
on bd.beneficiary_id = id.beneficiary_id
left join
  outpatient_data as od
on bd.beneficiary_id = od.beneficiary_id
left join 
  provider_info as pi
on id.provider = pi.provider
where ip_first_claim = 1
and op_first_claim = 1